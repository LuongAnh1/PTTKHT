<!DOCTYPE html>
<html lang="vi">
<head>
    <!-- (Giữ nguyên phần Head cũ) -->
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Quản lý Giá & Khuyến mãi</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { primary: "#3B82F6", "background-light": "#F3F4F6", "background-dark": "#111827" },
                    fontFamily: { display: ["Roboto", "sans-serif"] },
                    borderRadius: { DEFAULT: "0.5rem" },
                },
            },
        };
    </script>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24 }
    </style>

    <!-- [QUAN TRỌNG] SCRIPT CHẶN QUYỀN TRUY CẬP (ĐẶT Ở ĐÂY ĐỂ CHẠY SỚM NHẤT) -->
    <script>
        (function() {
            const token = localStorage.getItem('token');
            const userJson = localStorage.getItem('user');

            if (!token || !userJson) {
                window.location.href = '/PTTKHT/QTHT/DN/code.html';
                return;
            }

            const user = JSON.parse(userJson);
            const role = parseInt(user.QuyenHan);

            // NẾU LÀ KHO (Role 3) -> CHẶN NGAY LẬP TỨC
            if (role === 3) {
                alert("Bạn không có quyền truy cập trang này!");
                // Chuyển hướng về trang chủ hoặc trang Kho
                window.location.href = '/PTTKHT/QLK/NK/code.html'; 
            }
        })();
    </script>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-gray-800 dark:text-gray-200">
<div class="flex h-screen">
    <!-- SIDEBAR (Giữ nguyên) -->
    <aside class="w-64 bg-[#111827] text-gray-300 flex flex-col flex-shrink-0">
        <div class="p-6">
            <div class="flex items-center space-x-3">
                <span class="material-symbols-outlined text-3xl text-white">settings</span>
                <h1 class="text-xl font-bold text-white">Admin</h1>
            </div>
        </div>
        <nav class="flex-1 px-4 py-4 space-y-2 border-t border-gray-700 overflow-y-auto">
            <a class="flex items-center px-4 py-2.5 rounded-lg hover:bg-gray-700 hover:text-white transition-colors" href="/PTTKHT/TC/code.html">
                <span class="material-symbols-outlined mr-3">home</span> Trang chủ
            </a>
            <a class="flex items-center px-4 py-2.5 rounded-lg hover:bg-gray-700 hover:text-white transition-colors" href="/PTTKHT/QTHT/QLND/code.html">
                <span class="material-symbols-outlined mr-3">settings_system_daydream</span> Quản trị hệ thống
            </a>
            <a class="bg-primary text-white flex items-center px-4 py-2.5 rounded-lg font-semibold" href="#">
                <span class="material-symbols-outlined mr-3">category</span> Quản lý thông tin danh mục
            </a>
            <a class="flex items-center px-4 py-2.5 rounded-lg hover:bg-gray-700 hover:text-white transition-colors" href="/PTTKHT/QLK/NK/code.html">
                <span class="material-symbols-outlined mr-3">warehouse</span> Quản lý kho
            </a>
            <a class="flex items-center px-4 py-2.5 rounded-lg hover:bg-gray-700 hover:text-white transition-colors" href="/PTTKHT/BCTK/BCTK/code.html">
                <span class="material-symbols-outlined mr-3">bar_chart</span> Báo cáo &amp; Thống kê
            </a>
        </nav>
        <div class="p-4 border-t border-gray-700">
            <a class="flex items-center px-4 py-2.5 rounded-lg hover:bg-gray-700 hover:text-white transition-colors" href="#">
                <span class="material-symbols-outlined mr-3">account_circle</span> <span id="user-display">User</span>
            </a>
            <a id="btn-logout" class="flex items-center px-4 py-2.5 rounded-lg hover:bg-gray-700 hover:text-white transition-colors cursor-pointer">
                <span class="material-symbols-outlined mr-3">logout</span> Đăng xuất
            </a>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 p-8 overflow-y-auto bg-gray-50 dark:bg-gray-900">
        <!-- (Giữ nguyên phần Header & Content Sections) -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-8">
            <div class="p-6">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Quản lý Thông tin Danh mục</h2>
                    <p class="text-gray-500 dark:text-gray-400">Chọn một mục để xem và quản lý chi tiết.</p>
                </div>
                <div>
                    <nav aria-label="Tabs" class="flex space-x-2 border-b border-gray-200 dark:border-gray-700 overflow-x-auto">
                        <a href="../QLN_va_BST/code.html" class="border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 hover:border-gray-300 px-4 py-3 font-medium text-sm transition-colors whitespace-nowrap">
                            Nhóm & Bộ sưu tập
                        </a>
                        <a href="../QLSP_va_BT/code.html" class="border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 hover:border-gray-300 px-4 py-3 font-medium text-sm transition-colors whitespace-nowrap">
                            Sản phẩm & Biến thể
                        </a>
                        <div class="border-b-2 border-blue-600 text-blue-600 px-4 py-3 font-medium text-sm whitespace-nowrap">
                            Giá & Khuyến mãi
                        </div>
                        <a href="../QLNCC/code.html" class="border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 hover:border-gray-300 px-4 py-3 font-medium text-sm transition-colors whitespace-nowrap">
                            Quản lý Nhà cung cấp
                        </a>
                    </nav>
                </div>
            </div>
        </div>

        <div class="space-y-8">
            <!-- 1. Bảng giá -->
            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-6 bg-white dark:bg-gray-800 shadow-sm">
                <div class="flex flex-col xl:flex-row justify-between items-start xl:items-center mb-6 gap-4">
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">price_change</span>
                            Quản lý Bảng giá
                        </h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Danh sách các bảng giá nhập, bán lẻ và bán buôn.</p>
                    </div>
                    <button onclick="openPriceModal('add')" class="bg-primary text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2 hover:bg-blue-600 transition-colors whitespace-nowrap shadow-sm text-sm">
                        <span class="material-symbols-outlined text-[18px]">add</span> Thêm bảng giá
                    </button>
                </div>
                
                <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden flex flex-col">
                    <div class="overflow-x-auto overflow-y-auto max-h-[300px]">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100 dark:bg-gray-900 text-gray-700 dark:text-gray-200 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-10">
                                <tr>
                                    <th class="px-6 py-3 whitespace-nowrap font-semibold">Tên bảng giá</th>
                                    <th class="px-6 py-3 whitespace-nowrap font-semibold">Mô tả</th>
                                    <th class="px-6 py-3 whitespace-nowrap font-semibold">Loại tiền tệ</th>
                                    <th class="px-6 py-3 whitespace-nowrap font-semibold">Trạng thái</th>
                                    <th class="px-6 py-3 text-right font-semibold">Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="priceListBody" class="divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-gray-800">
                                <!-- JS Render -->
                            </tbody>
                        </table>
                    </div>
                    <div class="flex-none flex items-center justify-between px-6 py-3 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-xs text-gray-500 dark:text-gray-400">
                        <div id="priceListCount">Đang tải...</div>
                    </div>
                </div>
            </div>

            <!-- 2. Chương trình Khuyến mãi -->
            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-6 bg-white dark:bg-gray-800 shadow-sm">
                <div class="flex flex-col xl:flex-row items-start xl:items-center justify-between gap-4 mb-6">
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2">
                            <span class="material-symbols-outlined text-red-500">campaign</span>
                            Chương trình Khuyến mãi
                        </h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Tạo và quản lý các đợt giảm giá, ưu đãi đặc biệt.</p>
                    </div>
                    <button onclick="openPromoModal('add')" class="bg-primary text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2 hover:bg-blue-600 transition-colors whitespace-nowrap shadow-sm text-sm">
                        <span class="material-symbols-outlined text-[18px]">add</span> Tạo chương trình
                    </button>
                </div>

                <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden flex flex-col">
                    <div class="overflow-x-auto overflow-y-auto max-h-[400px]">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100 dark:bg-gray-900 text-gray-700 dark:text-gray-200 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-10">
                                <tr>
                                    <th class="px-6 py-3 whitespace-nowrap font-semibold">Tên chương trình</th>
                                    <th class="px-6 py-3 whitespace-nowrap font-semibold">Thời gian áp dụng</th>
                                    <th class="px-6 py-3 whitespace-nowrap font-semibold">Sản phẩm áp dụng</th>
                                    <th class="px-6 py-3 whitespace-nowrap font-semibold">Mức giảm</th>
                                    <th class="px-6 py-3 whitespace-nowrap font-semibold">Trạng thái</th>
                                    <th class="px-6 py-3 text-right font-semibold">Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="promoBody" class="divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-gray-800">
                                <!-- JS Render -->
                            </tbody>
                        </table>
                    </div>
                    <div class="flex-none flex items-center justify-between px-6 py-3 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-xs text-gray-500 dark:text-gray-400">
                        <div id="promoCount">Đang tải...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Modal Price (Giữ nguyên) -->
<div id="modalPrice" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
     <!-- Form content (Keep as is) -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full max-w-md p-6">
        <div class="flex justify-between items-center mb-4 border-b pb-2 dark:border-gray-700">
            <h3 id="titlePrice" class="text-xl font-bold text-gray-900 dark:text-white">Thêm bảng giá</h3>
            <button onclick="closeModal('modalPrice')" class="text-gray-500 hover:text-red-500"><span class="material-symbols-outlined">close</span></button>
        </div>
        <form onsubmit="handleSavePriceList(event)">
            <input type="hidden" id="pl-id">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tên bảng giá</label>
                    <input type="text" id="pl-name" required class="w-full mt-1 rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Mô tả</label>
                    <textarea id="pl-desc" rows="2" class="w-full mt-1 rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tiền tệ</label>
                        <select id="pl-currency" class="w-full mt-1 rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm">
                            <option value="VNĐ">VNĐ</option>
                            <option value="USD">USD</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Trạng thái</label>
                        <select id="pl-status" class="w-full mt-1 rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm">
                            <option value="1">Hoạt động</option>
                            <option value="0">Vô hiệu</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button type="button" onclick="closeModal('modalPrice')" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm">Hủy</button>
                <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg text-sm">Lưu lại</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Promo (Giữ nguyên) -->
<div id="modalPromo" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
     <!-- Form content (Keep as is) -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full max-w-lg p-6">
        <div class="flex justify-between items-center mb-4 border-b pb-2 dark:border-gray-700">
            <h3 id="titlePromo" class="text-xl font-bold text-gray-900 dark:text-white">Tạo chương trình</h3>
            <button onclick="closeModal('modalPromo')" class="text-gray-500 hover:text-red-500"><span class="material-symbols-outlined">close</span></button>
        </div>
        <form onsubmit="handleSavePromo(event)">
            <input type="hidden" id="pm-id">
            <div class="space-y-4">
                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tên chương trình</label>
                        <input type="text" id="pm-name" required class="w-full mt-1 rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Mã Code</label>
                        <input type="text" id="pm-code" class="w-full mt-1 rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Ngày bắt đầu</label>
                        <input type="date" id="pm-start" required class="w-full mt-1 rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Ngày kết thúc</label>
                        <input type="date" id="pm-end" required class="w-full mt-1 rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Phạm vi áp dụng</label>
                    <input type="text" id="pm-scope" placeholder="VD: Toàn bộ áo thun" class="w-full mt-1 rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Mức giảm</label>
                        <input type="text" id="pm-discount" placeholder="VD: -50%" class="w-full mt-1 rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm font-bold text-red-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Trạng thái</label>
                        <select id="pm-status" class="w-full mt-1 rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm">
                            <option value="1">Đang diễn ra</option>
                            <option value="2">Sắp diễn ra</option>
                            <option value="0">Đã kết thúc</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button type="button" onclick="closeModal('modalPromo')" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm">Hủy</button>
                <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg text-sm">Lưu lại</button>
            </div>
        </form>
    </div>
</div>

<script>
    const API_MARKETING = '/api/marketing';
    let currentPriceLists = [];
    let currentPromos = [];
    
    // Lấy Token
    const token = localStorage.getItem('token');

    // Cập nhật User Info & Logout
    document.addEventListener('DOMContentLoaded', () => {
        const userJson = localStorage.getItem('user');
        if (userJson) {
            const user = JSON.parse(userJson);
            document.getElementById('user-display').innerText = user.HoTen || user.TenDangNhap;
        }
        
        document.getElementById('btn-logout').addEventListener('click', () => {
             localStorage.clear();
             window.location.href = '/PTTKHT/QTHT/DN/code.html';
        });

        loadPriceLists();
        loadPromotions();
    });

    // --- HELPER AUTH FETCH ---
    async function authFetch(url, options = {}) {
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}` 
        };
        const config = { ...options, headers: { ...headers, ...options.headers } };
        return fetch(url, config);
    }

    // --- 1. QUẢN LÝ BẢNG GIÁ ---
    async function loadPriceLists() {
        try {
            const res = await authFetch(`${API_MARKETING}/price-lists`);
            // Nếu bị chặn quyền (đề phòng)
            if (res.status === 403) return;

            const json = await res.json();
            const tbody = document.getElementById('priceListBody');
            tbody.innerHTML = '';

            if (json.success) {
                currentPriceLists = json.data;
                json.data.forEach(item => {
                    const statusHtml = item.TrangThai == 1 
                        ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">Đang hoạt động</span>`
                        : `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">Vô hiệu</span>`;

                    const row = `
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                            <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">${item.TenBangGia}</td>
                            <td class="px-6 py-4 text-gray-500">${item.MoTa || ''}</td>
                            <td class="px-6 py-4">${item.LoaiTienTe}</td>
                            <td class="px-6 py-4">${statusHtml}</td>
                            <td class="px-6 py-4 text-right">
                                <div class="flex items-center justify-end gap-2">
                                    <button onclick="openPriceModal('edit', ${item.ID})" class="text-gray-500 hover:text-primary p-1"><span class="material-symbols-outlined text-[20px]">edit</span></button>
                                    <button onclick="deletePriceList(${item.ID})" class="text-gray-500 hover:text-red-500 p-1"><span class="material-symbols-outlined text-[20px]">delete</span></button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
                document.getElementById('priceListCount').innerText = `Tổng số: ${json.data.length} bảng giá`;
            }
        } catch (e) { console.error(e); }
    }

    function openPriceModal(mode, id = null) {
        document.getElementById('modalPrice').classList.remove('hidden');
        document.getElementById('pl-id').value = '';
        document.getElementById('pl-name').value = '';
        document.getElementById('pl-desc').value = '';
        document.getElementById('pl-currency').value = 'VNĐ';
        document.getElementById('pl-status').value = '1';

        if (mode === 'add') {
            document.getElementById('titlePrice').innerText = "Thêm bảng giá";
        } else {
            document.getElementById('titlePrice').innerText = "Cập nhật bảng giá";
            const item = currentPriceLists.find(x => x.ID == id);
            if (item) {
                document.getElementById('pl-id').value = item.ID;
                document.getElementById('pl-name').value = item.TenBangGia;
                document.getElementById('pl-desc').value = item.MoTa;
                document.getElementById('pl-currency').value = item.LoaiTienTe;
                document.getElementById('pl-status').value = item.TrangThai;
            }
        }
    }

    async function handleSavePriceList(e) {
        e.preventDefault();
        const id = document.getElementById('pl-id').value;
        const payload = {
            ten: document.getElementById('pl-name').value,
            moTa: document.getElementById('pl-desc').value,
            tienTe: document.getElementById('pl-currency').value,
            trangThai: document.getElementById('pl-status').value
        };
        const method = id ? 'PUT' : 'POST';
        const url = id ? `${API_MARKETING}/price-lists/${id}` : `${API_MARKETING}/price-lists`;

        try {
            const res = await authFetch(url, {
                method: method,
                body: JSON.stringify(payload)
            });
            const json = await res.json();
            if (json.success) {
                alert(json.message);
                closeModal('modalPrice');
                loadPriceLists();
            } else alert(json.message);
        } catch (e) { alert('Lỗi kết nối'); }
    }

    async function deletePriceList(id) {
        if (!confirm('Bạn có chắc muốn xóa bảng giá này?')) return;
        try {
            const res = await authFetch(`${API_MARKETING}/price-lists/${id}`, { method: 'DELETE' });
            if ((await res.json()).success) { alert('Đã xóa'); loadPriceLists(); }
        } catch (e) { alert('Lỗi kết nối'); }
    }


    // --- 2. QUẢN LÝ KHUYẾN MÃI ---
    async function loadPromotions() {
        try {
            const res = await authFetch(`${API_MARKETING}/promotions`);
            // Nếu bị chặn quyền
            if (res.status === 403) return;

            const json = await res.json();
            const tbody = document.getElementById('promoBody');
            tbody.innerHTML = '';

            if (json.success) {
                currentPromos = json.data;
                json.data.forEach(item => {
                    let statusBadge = '';
                    if (item.TrangThai == 1) statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 animate-pulse">Đang diễn ra</span>`;
                    else if (item.TrangThai == 2) statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">Sắp diễn ra</span>`;
                    else statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-300">Đã kết thúc</span>`;

                    const formatDate = (d) => d ? new Date(d).toLocaleDateString('vi-VN') : '';

                    const row = `
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors ${item.TrangThai == 0 ? 'opacity-75' : ''}">
                            <td class="px-6 py-4">
                                <div class="font-medium text-gray-900 dark:text-white">${item.TenCT}</div>
                                <div class="text-xs text-gray-500 mt-0.5">Mã: ${item.MaCode || '---'}</div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-gray-700 dark:text-gray-300">${formatDate(item.NgayBatDau)} - ${formatDate(item.NgayKetThuc)}</div>
                            </td>
                            <td class="px-6 py-4 max-w-[200px] truncate">${item.PhamViApDung}</td>
                            <td class="px-6 py-4"><span class="text-red-600 font-semibold">${item.MucGiam}</span></td>
                            <td class="px-6 py-4">${statusBadge}</td>
                            <td class="px-6 py-4 text-right">
                                <div class="flex items-center justify-end gap-2">
                                    <button onclick="openPromoModal('edit', ${item.ID})" class="text-gray-500 hover:text-primary p-1"><span class="material-symbols-outlined text-[20px]">edit</span></button>
                                    <button onclick="deletePromo(${item.ID})" class="text-gray-500 hover:text-red-500 p-1"><span class="material-symbols-outlined text-[20px]">delete</span></button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
                document.getElementById('promoCount').innerText = `Tổng số: ${json.data.length} chương trình`;
            }
        } catch (e) { console.error(e); }
    }

    function openPromoModal(mode, id = null) {
        document.getElementById('modalPromo').classList.remove('hidden');
        document.getElementById('pm-id').value = '';
        document.getElementById('pm-name').value = '';
        document.getElementById('pm-code').value = '';
        document.getElementById('pm-start').value = '';
        document.getElementById('pm-end').value = '';
        document.getElementById('pm-scope').value = '';
        document.getElementById('pm-discount').value = '';
        document.getElementById('pm-status').value = '2';

        if (mode === 'add') {
            document.getElementById('titlePromo').innerText = "Tạo chương trình";
        } else {
            document.getElementById('titlePromo').innerText = "Cập nhật chương trình";
            const item = currentPromos.find(x => x.ID == id);
            if (item) {
                document.getElementById('pm-id').value = item.ID;
                document.getElementById('pm-name').value = item.TenCT;
                document.getElementById('pm-code').value = item.MaCode;
                document.getElementById('pm-start').value = item.NgayBatDau.split('T')[0];
                document.getElementById('pm-end').value = item.NgayKetThuc.split('T')[0];
                document.getElementById('pm-scope').value = item.PhamViApDung;
                document.getElementById('pm-discount').value = item.MucGiam;
                document.getElementById('pm-status').value = item.TrangThai;
            }
        }
    }

    async function handleSavePromo(e) {
        e.preventDefault();
        const id = document.getElementById('pm-id').value;
        const payload = {
            ten: document.getElementById('pm-name').value,
            code: document.getElementById('pm-code').value,
            batDau: document.getElementById('pm-start').value,
            ketThuc: document.getElementById('pm-end').value,
            phamVi: document.getElementById('pm-scope').value,
            mucGiam: document.getElementById('pm-discount').value,
            trangThai: document.getElementById('pm-status').value
        };
        const method = id ? 'PUT' : 'POST';
        const url = id ? `${API_MARKETING}/promotions/${id}` : `${API_MARKETING}/promotions`;

        try {
            const res = await authFetch(url, {
                method: method,
                body: JSON.stringify(payload)
            });
            if ((await res.json()).success) {
                alert('Thành công!');
                closeModal('modalPromo');
                loadPromotions();
            } else alert('Lỗi!');
        } catch (e) { alert('Lỗi kết nối'); }
    }

    async function deletePromo(id) {
        if (!confirm('Xóa chương trình này?')) return;
        try {
            const res = await authFetch(`${API_MARKETING}/promotions/${id}`, { method: 'DELETE' });
            if ((await res.json()).success) { alert('Đã xóa'); loadPromotions(); }
        } catch (e) { alert('Lỗi kết nối'); }
    }

    function closeModal(id) {
        document.getElementById(id).classList.add('hidden');
    }
</script>
</body>
</html>